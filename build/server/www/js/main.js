var config={},server={},iconSize=20,gridSize=38.5,session=void 0,locationUpdateRate=5,allies=[],recent=[],locations={},$sessioninfo=$("#sessioninfo"),$friends=$("#friends"),$allieslist=$("#allieslist"),$recentlist=$("#recentlist"),$buildings=$("#buildings"),$landmarks=$("#landmarks"),$grid=$("#grid"),$layers=$("#grid, #buildings, #landmarks");
function updateStatus(b){console.log("updating status ...");$.getJSON("/status.json",function(a){server=a;$("#hostname").text(server.hostname);$("#level").text(_(server.level)).prop("title",_("Worldsize {WORLDSIZE}, Seed {SEED}",{WORLDSIZE:server.worldsize,SEED:server.seed}));$("#numplayers").text(_("{NUM} / {MAX} players",{NUM:server.numplayers,MAX:server.maxplayers}));$("#numsleepers").text(_("{NUM} sleepers",{NUM:server.sleepers}));document.title=server.hostname;console.log("status updated");b&&
b()}).fail(function(a,c){console.log("status update failed: "+c.message)})}
function updateMonuments(b){console.log("updating monuments ...");$.getJSON("/monuments.json",function(a){$.each(a,function(a,b){var d,f;/wolf_monument/.test(b.name)?(d="/img/wolf.png",f=_("Wolf Monument")):/lighthouse_monument/.test(b.name)?(d="/img/lighthouse.png",f=_("Lighthouse")):/dish_monument/.test(b.name)?(d="/img/dish.png",f=_("Satellite Dish")):/cave/.test(b.name)?(d="/img/cave.png",f=_("Cave")):/radtown/.test(b.name)&&(d="/img/radtown.png",f=_("Radtown"));d&&(elem=$('<img class="monument" src="'+
d+'" alt="" title="'+f+'" />'),d=worldToMap(b.position),elem.css({width:iconSize+"px",left:d.x-iconSize/2+"px",top:d.y-iconSize/2+"px"}),$landmarks.append(elem))});console.log("monuments updated");b&&b()}).fail(function(a,c){console.log("monuments update failed: "+c.message)})}
function updateBuildings(b){console.log("updating buildings ...");$.getJSON("/buildings.json",function(a){var c=document.getElementById("buildings"),e=c.getContext("2d");e.clearRect(0,0,c.width,c.height);var d=server.worldsize/1E3*.4;$.each(a,function(a,c){if("foundation"==c.name){var b=worldToMap(c.position);e.save();e.moveTo(b.x,b.y);e.translate(b.x,b.y);e.rotate(c.rotation/180*Math.PI);e.fillStyle="rgba(0,0,0,0.5)";e.fillRect(-d/2-.5,-d/2-.5,d+1,d+1);e.restore()}});$.each(a,function(a,c){if("foundation"==
c.name){var b=worldToMap(c.position);e.save();e.moveTo(b.x,b.y);e.translate(b.x,b.y);e.rotate(c.rotation/180*Math.PI);e.fillStyle="#ae8753";e.fillRect(-d/2,-d/2,d,d);e.restore()}});console.log("buildings updated");b&&b()}).fail(function(b,c){console.log("buildings update failed: "+c.message)})}
function updatePlayerLocation(b,a){var c,e=worldToMap(b),d=b.r;locations.hasOwnProperty(b.id)?(c=locations[b.id],c.pos=[c.pos[1],e],c.rot=[c.rot[1],d]):(console.log("creating player "+b.id),$landmarks.append(elem=$('<img class="player" alt="" id="player-'+b.id+'" />')),elem.prop("src","/img/"+(userId===b.id?"self":isShare(b.id)?"ally":"player")+".png"),elem.prop("title",userId===b.id?_("This is you!"):(c=findRecent(b.id))?c.name:b.id),elem.css({width:iconSize+"px",left:e.x-iconSize/2+"px",top:e.y-
iconSize/2+"px",transform:"rotate("+d+"deg)"}),c=locations[b.id]={},c.pos=[e,e],c.rot=[d,d],c.elem=elem,c.dead=!1);c.time=Date.now()}function updateSleeperLocation(b){updatePlayerLocation(b,!0)}function findAlly(b){for(var a=0;a<allies.length;++a)if(allies[a].id==b)return allies[a];return null}function isFriend(b){if(!session)return!1;for(var a=0;a<session.friends.length;++a)if(session.friends[a].id==b)return!0;return!1}
function isShare(b){if(!session)return!1;for(var a=0;a<session.shares.length;++a)if(session.shares[a].id==b)return!0;return!1}function addFriend(b,a){findAlly(b);connect.socket&&!isFriend(b)&&b!=session.id&&confirm(_('Do you really want to SHARE your location with "{NAME}"?',{NAME:a}))&&(console.log("requesting add of friend "+b),connect.socket.send("friend.add "+JSON.stringify({id:b})))}
function deleteFriend(b,a){findAlly(b);connect.socket&&isFriend(b)&&confirm(_('Do you really want to NO LONGER SHARE your location with "{NAME}"?',{NAME:a}))&&(console.log("requesting delete of friend "+b),connect.socket.send("friend.del "+JSON.stringify({id:b})))}
function deleteForeignFriend(b,a){findAlly(b);connect.socket&&(isFriend(b)||isAlly(b))&&confirm(_('Do you really want to MUTUALLY DELETE your connection to "{NAME}"?',{NAME:a}))&&(console.log("requesting delete of foreign friend "+b),connect.socket.send("foreign.del "+JSON.stringify({id:b})))}
function updateAllies(){if(session){for(var b=[],a=0;a<allies.length;)isFriend(allies[a].id)||isShare(allies[a].id)?++a:(console.log("clearing ally: "+allies[a].id),$("#ally-"+allies[a].id).remove(),allies.splice(a,1));a=session.friends.slice();Array.prototype.push.apply(a,session.shares);$.each(a,function(c,a){if(!(0<=b.indexOf(a.id))){var d=findAlly(a.id);if(null==d){console.log("creating ally: "+a.id);d={};d.id=a.id;d.name=a.name;allies.push(d);d.elem=$('<a id="ally-'+d.id+'" class="player" />');
d.elem.text(d.name);d.elem.click(function(){isFriend(d.id)?deleteFriend(d.id,d.name):addFriend(d.id,d.name);return!1});d.elem.append($('<img class="icon" src="/img/revoke.png" />').click(function(a){deleteForeignFriend(d.id,d.name);a.stopPropagation();return!1}));var f=null;for(c in allies)if(allies.hasOwnProperty(c)&&allies[c].name.toLowerCase()>d.name.toLowerCase()){f=allies[c].elem;break}null!=f?d.elem.insertBefore(f):$allieslist.append(d.elem)}(d.isFriend=isFriend(a.id))?d.elem.addClass("friend"):
d.elem.removeClass("friend");(d.isShare=isShare(a.id))?d.elem.addClass("share"):d.elem.removeClass("share");(d.isMutual=d.isFriend&&d.isShare)?d.elem.addClass("mutual"):d.elem.removeClass("mutual");b.push(a.id)}})}}function findRecent(b){for(var a=0;a<recent.length;++a)if(recent[a].id==b)return recent[a];return null}
function addRecent(b,a){if(!session||session.id!=b){var c=findRecent(b);null==c&&(c={},c.id=b,c.name=a,recent.push(c));c.elem||(c.elem=$('<a id="recent-'+c.id+'" class="player "/>'),c.elem.text(c.name),c.elem.click(function(){addFriend(c.id,c.name);return!1}),$recentlist.append(c.elem));if(c.id!=session.id){var e=locations[c.id];e&&e.elem.prop("title",c.name)}return c}}
function updateRecent(){console.log("updating recent players ...");$.getJSON("/recent.json",function(b){$.each(b,function(a,b){addRecent(b.id,b.name)});console.log("updated recent players")}).fail(function(b,a){console.log("recent players update failed: "+a.message)})}
setInterval(function(){var b=Date.now();$.each(locations,function(a,c){var e=(b-c.time)/1E3;1<e&&(e=1);e=lerp(c.pos[0],c.pos[1],e);c.elem.css({left:e.x-iconSize/2+"px",top:e.y-iconSize/2+"px",transform:"rotate("+c.rot[1]+"deg)"})})},1E3/locationUpdateRate);var labelsX="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),labelsY=function(){for(var b=[],a=1;a<=labelsX.length;++a)b.push(""+a);return b}();
function updateGrid(){var b=document.getElementById("grid"),a=b.getContext("2d");a.clearRect(0,0,b.width,b.height);a.save();a.beginPath();for(b=gridSize;1E3>b;b+=gridSize)a.moveTo(b-.5,.5),a.lineTo(b-.5,999.5),a.moveTo(.5,b-.5),a.lineTo(999.5,b-.5);a.strokeStyle="rgba(255,255,255,0.08)";a.stroke();a.fillStyle="rgba(255,255,255,0.5)";a.font="18px sans-serif";for(var c=b=0;1E3>b;b+=gridSize,c++){var e=labelsY[c],d=labelsX[c],f=a.measureText(e);a.fillText(e,1E3+(gridSize-f.width)/2,b+18+(gridSize-18)/
2-4);f=a.measureText(d);a.fillText(d,b+(gridSize-f.width)/2,1029)}a.restore()}
function connect(){if("undefined"==typeof WebSocket)alert(_("Sorry, your browser does not support WebSockets. Please consider an upgrade to use RustWeb!"));else{console.log("connecting to websocket ...");var b=connect.socket=new WebSocket("ws://"+document.location.hostname+":"+document.location.port+"/ws");b.onopen=function(){console.log("connected to websocket")};b.onmessage=function(a){var c=a.data,e=c.indexOf(" ");0>e?(a=c,c=null):(a=c.substring(0,e),c=JSON.parse(c.substring(e+1)));switch(a){case "hello":console.log("greeted by server");
b.send("hello");break;case "session":console.log("received session info: "+c._id);session=c;userId=c.id;toggleCss("signedin",!0);$sessioninfo.text(session.name);notify(_("{YOU} just signed in",{YOU:"<strong>"+_("You")+"</strong>"}));updateAllies();updateRecent();session.owner&&!config.displayBuildings&&(toggleCss("displayBuildings",!0),updateBuildings(),setInterval(updateBuildings,3E5));break;case "friend.add":console.log("received added friend: "+c.id);session.friends.push(c);updateAllies();notify(_("{YOU} now share your location with {NAME}",
{YOU:"<strong>"+_("You")+"</strong>",NAME:"<strong>"+escapeHtml(c.name)+"</strong>"}));break;case "friend.del":console.log("received deleted friend: "+c.id);for(a=0;a<session.friends.length;++a)if(session.friends[a].id==c.id){session.friends.splice(a,1);updateAllies();notify(_("{YOU} no longer share your location with {NAME}",{YOU:"<strong>"+_("You")+"</strong>",NAME:"<strong>"+escapeHtml(c.name)+"</strong>"}));break}break;case "share.add":console.log("received added share: "+c.id);session.shares.push(c);
updateAllies();notify(_("{NAME} now shares their location with you",{NAME:"<strong>"+escapeHtml(c.name)+"</strong>"}));(a=locations[c.id])&&a.elem.prop("src","/img/ally.png");break;case "share.del":console.log("received deleted share: "+c.id);for(a=0;a<session.shares.length;++a)if(session.shares[a].id==c.id){session.shares.splice(a,1);updateAllies();if(a=locations[c.id])a.elem.remove(),delete locations[c.id];notify(_("{NAME} no longer shares their location with you",{NAME:"<strong>"+escapeHtml(c.name)+
"</strong>"}));break}break;case "l":updatePlayerLocation(c);break;case "s":updateSleeperLocation(c);break;case "player.connect":console.log("received player connect: "+c.id);session.owner&&notify(_("{NAME} just woke up",{NAME:"<strong>"+escapeHtml(c.name)+"</strong>"}));$recentlist.prepend(addRecent(c.id,c.name).elem.detach());break;case "player.disconnect":console.log("received player disconnect: "+c.id);session.owner&&notify(_("{NAME} fell asleep",{NAME:"<strong>"+escapeHtml(c.name)+"</strong>"}));
if(a=locations[c.id])a.elem.remove(),delete locations[c.id];break;case "player.chat":console.log("received player spawn: "+c.id);notify(_("{NAME} says:",{NAME:"<strong>"+escapeHtml(c.name)+"</strong>"})+" "+escapeHtml(c.message));break;case "player.spawn":console.log("received player spawn: "+c.id);notify(_("{NAME} spawned in the middle of nowhere",{NAME:"<strong>"+escapeHtml(c.name)+"</strong>"}));if(a=locations[c.id])a.dead=!1;break;case "player.death":console.log("received player death: "+c.id);
notify(_(damageToReason(c.lastDamage),{NAME:"<strong>"+escapeHtml(c.name)+"</strong>"}));if(a=locations[c.id])a.dead=!0;break;default:console.log("received unknown command: "+a)}};b.onclose=function(a){console.log("disconnected from websocket (trying to reconnect in 20s)");setTimeout(function(){connect()},2E4);toggleCss("signedin",!1);$sessionfinfo.text("Not logged in");delete connect.socket;cleanup()};b.onerror=function(a){console.log("websocket error: "+a.error)}}}
function init(){console.log("loading config ...");$.getJSON("/config.json",function(b){config=b;toggleCss("displayMonuments",!!config.displayMonuments);toggleCss("displayBuildings",!!config.displayBuildings);console.log("config loaded");updateStatus(function(){setInterval(updateStatus,6E4);config&&config.displayMonuments&&updateMonuments();config&&config.displayBuildings&&(updateBuildings(),setInterval(updateBuildings,3E5));connect()})}).fail(function(b,a){console.log("loading config failed:",a)})}
$(document).ready(function(){console.log("initializing ...");toggleCss("signedin",!1);updateGrid();var b=$("#landmarks-checkbox");b.change(function(){$landmarks.css("display",b.is(":checked")?"block":"none")});var a=$("#buildings-checkbox");a.change(function(){$buildings.css("display",a.is(":checked")?"block":"none")});var c=$("#grid-checkbox");c.change(function(){$grid.css("display",c.is(":checked")?"block":"none")});$layers.bind("mousemove",function(a){1E3<a.offsetX||1E3<a.offsetY||(a=mapToWorld({x:a.offsetX,
y:a.offsetY}),$(this).prop("title",Math.round(a.x)+" / "+Math.round(a.z)))});$("#allieslist, #recentlist").bind("mousewheel DOMMouseScroll",function(a){var b;"mousewheel"==a.type?b=-1*a.originalEvent.wheelDelta:"DOMMouseScroll"==a.type&&(b=20*a.originalEvent.detail);if(b)return a.stopPropagation(),a.preventDefault(),$(this).scrollTop(b+$(this).scrollTop()),!1});var e=$("#recent-filter");e.bind("change keyup",function(a){var b=e.val().toLowerCase();0==b.length?$recentlist.find(".player").show():$recentlist.find(".player").each(function(a,
c){c=$(c);0<=c.text().toLowerCase().indexOf(b)?c.show():c.hide()})});console.log("loading languages ...");var d=$("#langselect");d.change(function(){$.cookie("lang",d.val());document.location.href=document.location.href});$.getJSON("/languages.json",function(a){var b=[];d.empty();$.each(a,function(a,c){b.push(c.name+" ("+c.code+")");d.append($('<option value="'+c.code+'" />').text(c.name))});d.val("en");console.log("available languages: "+b.join(", "));i18n.languages=a;var c=$.cookie("lang");c&&"en"!=
c?i18n.load(c,function(a){a||d.val(c);init()}):init()}).fail(function(a,b){console.log("loading languages failed:",b);init()});onResize()});function cleanup(){$.each(allies,function(b,a){a.elem.remove()});$.each(recent,function(b,a){a.elem.remove()});$.each(locations,function(b,a){a.elem.remove()});session=null;allies=[];recent=[];locations={}}function onResize(){var b=($(window).height()-250)/2;$allieslist.css("max-height",b+"px");$recentlist.css("max-height",b+"px")}$(window).resize(onResize);
